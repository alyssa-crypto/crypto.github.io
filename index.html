<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>艾丽莎加密 - 全币种行情+K线</title>
    <style>
        /* 全局样式 */
        :root {
            --primary: #4a2c82;
            --secondary: #6a3cb5;
            --green: #16c784;
            --red: #ea3943;
        }
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* 搜索框 */
        #search {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        /* 行情表格 */
        #cryptoTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        #cryptoTable th, #cryptoTable td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        #cryptoTable th {
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: sticky;
            top: 0;
        }
        #cryptoTable tr:hover {
            background: #f5f5ff;
        }
        .up { color: var(--green); }
        .down { color: var(--red); }
        .coin-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .coin-icon {
            width: 24px;
            height: 24px;
        }
        
        /* K线容器 */
        #kline-container {
            margin-top: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        .kline-header {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .timeframe-buttons {
            display: flex;
            gap: 8px;
        }
        .timeframe-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .timeframe-btn.active {
            background: white;
            color: var(--primary);
        }
        #tradingview-kline {
            height: 500px;
            background: white;
        }
        .close-btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 15px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            #cryptoTable th, #cryptoTable td {
                padding: 10px 8px;
                font-size: 14px;
            }
            #tradingview-kline {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <h1>📈 加密货币实时行情分析</h1>
    
    <!-- 搜索框 -->
    <input type="text" id="search" placeholder="搜索币种名称或代码...">
    
    <!-- 行情表格 -->
    <table id="cryptoTable">
        <thead>
            <tr>
                <th onclick="sortTable('market_cap_rank')">#</th>
                <th onclick="sortTable('name')">名称</th>
                <th onclick="sortTable('current_price')">价格(USD)</th>
                <th onclick="sortTable('price_change_percentage_24h')">24h涨跌</th>
                <th onclick="sortTable('market_cap')">市值</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody id="cryptoData"></tbody>
    </table>
    
    <!-- K线图容器 -->
    <div id="kline-container">
        <div class="kline-header">
            <h2 id="kline-title">BTC/USDT</h2>
            <div>
                <div class="timeframe-buttons">
                    <button class="timeframe-btn active" onclick="changeKlinePeriod('15')">15分</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('60')">1小时</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('240')">4小时</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('D')">日线</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('W')">周线</button>
                </div>
            </div>
            <button class="close-btn" onclick="hideKline()">× 关闭</button>
        </div>
        <div id="tradingview-kline"></div>
    </div>
    
    <!-- 页脚 -->
    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
        数据最后更新: <span id="lastUpdate"></span> | 数据来源: CoinGecko API
    </div>

    <!-- TradingView脚本 -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // 全局变量
        let allCoinsData = [];
        let klineChart = null;
        let currentSortKey = 'market_cap_rank';
        let isAscending = true;
        
        // 主初始化函数
        async function init() {
            await fetchData();
            setInterval(fetchData, 60000); // 每分钟刷新数据
            setupSearch();
            bindTableEvents();
            
            // 默认显示BTC K线
            setTimeout(() => {
                const btcRow = document.querySelector('[data-symbol="btc"]');
                if (btcRow) btcRow.click();
            }, 1000);
        }
        
        // 获取数据
        async function fetchData() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false');
                allCoinsData = await response.json();
                renderTable(allCoinsData);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('获取数据失败:', error);
                alert('数据加载失败，请刷新页面重试');
            }
        }
        
        // 渲染表格
        function renderTable(data) {
            const tbody = document.getElementById('cryptoData');
            tbody.innerHTML = '';
            
            data.forEach(coin => {
                const changeClass = coin.price_change_percentage_24h >= 0 ? 'up' : 'down';
                const changeValue = coin.price_change_percentage_24h?.toFixed(2) || '0.00';
                
                const row = document.createElement('tr');
                row.dataset.symbol = coin.symbol;
                row.innerHTML = `
                    <td>${coin.market_cap_rank || '-'}</td>
                    <td>
                        <div class="coin-name">
                            <img src="${coin.image}" alt="${coin.name}" class="coin-icon">
                            ${coin.name} <span style="color:#666;">${coin.symbol.toUpperCase()}</span>
                        </div>
                    </td>
                    <td>$${coin.current_price?.toLocaleString() || '-'}</td>
                    <td class="${changeClass}">${changeValue}%</td>
                    <td>$${coin.market_cap?.toLocaleString() || '-'}</td>
                    <td><button class="view-kline-btn" data-symbol="${coin.symbol}">查看K线</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 设置搜索功能
        function setupSearch() {
            document.getElementById('search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#cryptoData tr').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });
        }
        
        // 绑定表格事件
        function bindTableEvents() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-kline-btn')) {
                    const symbol = e.target.dataset.symbol;
                    showKline(symbol);
                }
            });
        }
        
        // 显示K线图
        function showKline(symbol) {
            const coin = allCoinsData.find(c => c.symbol === symbol);
            if (!coin) return;
            
            // 更新UI
            document.getElementById('kline-title').textContent = `${coin.name} (${coin.symbol.toUpperCase()}/USDT)`;
            document.getElementById('kline-container').style.display = 'block';
            
            // 销毁旧图表
            if (klineChart) {
                klineChart.remove();
            }
            
            // 创建新图表
            klineChart = new TradingView.widget({
                "autosize": true,
                "symbol": `BINANCE:${coin.symbol.toUpperCase()}USDT`,
                "interval": "15",
                "timezone": "Asia/Shanghai",
                "theme": "light",
                "style": "1",
                "locale": "zh_CN",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "container_id": "tradingview-kline",
                "studies": [
                    "MA@tv-basicstudies",
                    "RSI@tv-basicstudies"
                ]
            });
            
            // 滚动到图表
            document.getElementById('kline-container').scrollIntoView({ behavior: 'smooth' });
            
            // 激活第一个时间周期按钮
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.timeframe-btn').classList.add('active');
        }
        
        // 切换K线周期
        function changeKlinePeriod(period) {
            if (klineChart) {
                klineChart.chart().setResolution(period);
                // 更新按钮状态
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }
        
        // 隐藏K线
        function hideKline() {
            document.getElementById('kline-container').style.display = 'none';
        }
        
        // 表格排序
        function sortTable(key) {
            if (currentSortKey === key) {
                isAscending = !isAscending;
            } else {
                currentSortKey = key;
                isAscending = true;
            }
            
            allCoinsData.sort((a, b) => {
                const valA = a[key] || 0;
                const valB = b[key] || 0;
                return isAscending ? valA - valB : valB - valA;
            });
            
            renderTable(allCoinsData);
        }
        
        // 页面加载初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>
