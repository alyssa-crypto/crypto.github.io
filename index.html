<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰¾ä¸½èåŠ å¯† - å…¨å¸ç§è¡Œæƒ…+Kçº¿</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        :root {
            --primary: #4a2c82;
            --secondary: #6a3cb5;
            --green: #16c784;
            --red: #ea3943;
        }
        body {
            font-family: 'Arial', sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: #f8f9fa;
            color: #333;
        }
        h1 {
            color: var(--primary);
            text-align: center;
            margin-bottom: 20px;
        }
        
        /* æœç´¢æ¡† */
        #search {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        /* è¡Œæƒ…è¡¨æ ¼ */
        #cryptoTable {
            width: 100%;
            border-collapse: collapse;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
        }
        #cryptoTable th, #cryptoTable td {
            padding: 14px 16px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        #cryptoTable th {
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
            position: sticky;
            top: 0;
        }
        #cryptoTable tr:hover {
            background: #f5f5ff;
        }
        .up { color: var(--green); }
        .down { color: var(--red); }
        .coin-name {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .coin-icon {
            width: 24px;
            height: 24px;
        }
        
        /* Kçº¿å®¹å™¨ */
        #kline-container {
            margin-top: 30px;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }
        .kline-header {
            background: var(--primary);
            color: white;
            padding: 12px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .timeframe-buttons {
            display: flex;
            gap: 8px;
        }
        .timeframe-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .timeframe-btn.active {
            background: white;
            color: var(--primary);
        }
        #tradingview-kline {
            height: 500px;
            background: white;
        }
        .close-btn {
            background: var(--red);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 15px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #cryptoTable th, #cryptoTable td {
                padding: 10px 8px;
                font-size: 14px;
            }
            #tradingview-kline {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <h1>ğŸ“ˆ åŠ å¯†è´§å¸å®æ—¶è¡Œæƒ…åˆ†æ</h1>
    
    <!-- æœç´¢æ¡† -->
    <input type="text" id="search" placeholder="æœç´¢å¸ç§åç§°æˆ–ä»£ç ...">
    
    <!-- è¡Œæƒ…è¡¨æ ¼ -->
    <table id="cryptoTable">
        <thead>
            <tr>
                <th onclick="sortTable('market_cap_rank')">#</th>
                <th onclick="sortTable('name')">åç§°</th>
                <th onclick="sortTable('current_price')">ä»·æ ¼(USD)</th>
                <th onclick="sortTable('price_change_percentage_24h')">24hæ¶¨è·Œ</th>
                <th onclick="sortTable('market_cap')">å¸‚å€¼</th>
                <th>æ“ä½œ</th>
            </tr>
        </thead>
        <tbody id="cryptoData"></tbody>
    </table>
    
    <!-- Kçº¿å›¾å®¹å™¨ -->
    <div id="kline-container">
        <div class="kline-header">
            <h2 id="kline-title">BTC/USDT</h2>
            <div>
                <div class="timeframe-buttons">
                    <button class="timeframe-btn active" onclick="changeKlinePeriod('15')">15åˆ†</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('60')">1å°æ—¶</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('240')">4å°æ—¶</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('D')">æ—¥çº¿</button>
                    <button class="timeframe-btn" onclick="changeKlinePeriod('W')">å‘¨çº¿</button>
                </div>
            </div>
            <button class="close-btn" onclick="hideKline()">Ã— å…³é—­</button>
        </div>
        <div id="tradingview-kline"></div>
    </div>
    
    <!-- é¡µè„š -->
    <div style="text-align: center; margin-top: 30px; color: #666; font-size: 14px;">
        æ•°æ®æœ€åæ›´æ–°: <span id="lastUpdate"></span> | æ•°æ®æ¥æº: CoinGecko API
    </div>

    <!-- TradingViewè„šæœ¬ -->
    <script src="https://s3.tradingview.com/tv.js"></script>
    
    <script>
        // å…¨å±€å˜é‡
        let allCoinsData = [];
        let klineChart = null;
        let currentSortKey = 'market_cap_rank';
        let isAscending = true;
        
        // ä¸»åˆå§‹åŒ–å‡½æ•°
        async function init() {
            await fetchData();
            setInterval(fetchData, 60000); // æ¯åˆ†é’Ÿåˆ·æ–°æ•°æ®
            setupSearch();
            bindTableEvents();
            
            // é»˜è®¤æ˜¾ç¤ºBTC Kçº¿
            setTimeout(() => {
                const btcRow = document.querySelector('[data-symbol="btc"]');
                if (btcRow) btcRow.click();
            }, 1000);
        }
        
        // è·å–æ•°æ®
        async function fetchData() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/coins/markets?vs_currency=usd&order=market_cap_desc&per_page=100&page=1&sparkline=false');
                allCoinsData = await response.json();
                renderTable(allCoinsData);
                document.getElementById('lastUpdate').textContent = new Date().toLocaleString();
            } catch (error) {
                console.error('è·å–æ•°æ®å¤±è´¥:', error);
                alert('æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
            }
        }
        
        // æ¸²æŸ“è¡¨æ ¼
        function renderTable(data) {
            const tbody = document.getElementById('cryptoData');
            tbody.innerHTML = '';
            
            data.forEach(coin => {
                const changeClass = coin.price_change_percentage_24h >= 0 ? 'up' : 'down';
                const changeValue = coin.price_change_percentage_24h?.toFixed(2) || '0.00';
                
                const row = document.createElement('tr');
                row.dataset.symbol = coin.symbol;
                row.innerHTML = `
                    <td>${coin.market_cap_rank || '-'}</td>
                    <td>
                        <div class="coin-name">
                            <img src="${coin.image}" alt="${coin.name}" class="coin-icon">
                            ${coin.name} <span style="color:#666;">${coin.symbol.toUpperCase()}</span>
                        </div>
                    </td>
                    <td>$${coin.current_price?.toLocaleString() || '-'}</td>
                    <td class="${changeClass}">${changeValue}%</td>
                    <td>$${coin.market_cap?.toLocaleString() || '-'}</td>
                    <td><button class="view-kline-btn" data-symbol="${coin.symbol}">æŸ¥çœ‹Kçº¿</button></td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // è®¾ç½®æœç´¢åŠŸèƒ½
        function setupSearch() {
            document.getElementById('search').addEventListener('input', (e) => {
                const term = e.target.value.toLowerCase();
                document.querySelectorAll('#cryptoData tr').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(term) ? '' : 'none';
                });
            });
        }
        
        // ç»‘å®šè¡¨æ ¼äº‹ä»¶
        function bindTableEvents() {
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('view-kline-btn')) {
                    const symbol = e.target.dataset.symbol;
                    showKline(symbol);
                }
            });
        }
        
        // æ˜¾ç¤ºKçº¿å›¾
        function showKline(symbol) {
            const coin = allCoinsData.find(c => c.symbol === symbol);
            if (!coin) return;
            
            // æ›´æ–°UI
            document.getElementById('kline-title').textContent = `${coin.name} (${coin.symbol.toUpperCase()}/USDT)`;
            document.getElementById('kline-container').style.display = 'block';
            
            // é”€æ¯æ—§å›¾è¡¨
            if (klineChart) {
                klineChart.remove();
            }
            
            // åˆ›å»ºæ–°å›¾è¡¨
            klineChart = new TradingView.widget({
                "autosize": true,
                "symbol": `BINANCE:${coin.symbol.toUpperCase()}USDT`,
                "interval": "15",
                "timezone": "Asia/Shanghai",
                "theme": "light",
                "style": "1",
                "locale": "zh_CN",
                "toolbar_bg": "#f1f3f6",
                "enable_publishing": false,
                "hide_side_toolbar": false,
                "container_id": "tradingview-kline",
                "studies": [
                    "MA@tv-basicstudies",
                    "RSI@tv-basicstudies"
                ]
            });
            
            // æ»šåŠ¨åˆ°å›¾è¡¨
            document.getElementById('kline-container').scrollIntoView({ behavior: 'smooth' });
            
            // æ¿€æ´»ç¬¬ä¸€ä¸ªæ—¶é—´å‘¨æœŸæŒ‰é’®
            document.querySelectorAll('.timeframe-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector('.timeframe-btn').classList.add('active');
        }
        
        // åˆ‡æ¢Kçº¿å‘¨æœŸ
        function changeKlinePeriod(period) {
            if (klineChart) {
                klineChart.chart().setResolution(period);
                // æ›´æ–°æŒ‰é’®çŠ¶æ€
                document.querySelectorAll('.timeframe-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }
        }
        
        // éšè—Kçº¿
        function hideKline() {
            document.getElementById('kline-container').style.display = 'none';
        }
        
        // è¡¨æ ¼æ’åº
        function sortTable(key) {
            if (currentSortKey === key) {
                isAscending = !isAscending;
            } else {
                currentSortKey = key;
                isAscending = true;
            }
            
            allCoinsData.sort((a, b) => {
                const valA = a[key] || 0;
                const valB = b[key] || 0;
                return isAscending ? valA - valB : valB - valA;
            });
            
            renderTable(allCoinsData);
        }
        
        // é¡µé¢åŠ è½½åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>
